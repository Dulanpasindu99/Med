// ---------- USER & ACCESS MODELS ----------
model User {
  id          String                     @id @default(cuid())
  name        String
  email       String                     @unique
  password    String
  role        Role                       @default(DOCTOR)
  memberships UserDispensaryMembership[]
  visits      Visit[]                    @relation("UserToVisit")
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
}

model UserDispensaryMembership {
  id           String      @id @default(cuid())
  user         User        @relation(fields: [userId], references: [id])
  userId       String
  dispensary   Dispensary? @relation(fields: [dispensaryId], references: [id])
  dispensaryId String?
}

// ---------- DISPENSARY ----------
model Dispensary {
  id        String                     @id @default(cuid())
  name      String
  address   String?
  patients  Patient[]
  users     UserDispensaryMembership[]
  createdAt DateTime                   @default(now())
  updatedAt DateTime                   @updatedAt
}

// ---------- FAMILY ----------
model Family {
  id        String    @id @default(cuid())
  title     String
  patients  Patient[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ---------- PATIENT ----------
model Patient {
  id           String      @id @default(cuid())
  nic          String      @unique
  firstName    String
  lastName     String?
  sex          String?
  dob          DateTime?
  phone        String?
  address      String?
  bloodGroup   String?
  notes        String?
  family       Family?     @relation(fields: [familyId], references: [id])
  familyId     String?
  dispensary   Dispensary? @relation(fields: [dispensaryId], references: [id])
  dispensaryId String?
  visits       Visit[]
  allergies    Allergy[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([dispensaryId, nic])
  @@index([dispensaryId, firstName, lastName])
}

// ---------- VISIT ----------
model Visit {
  id            String         @id @default(cuid())
  patient       Patient        @relation(fields: [patientId], references: [id])
  patientId     String
  doctor        User           @relation("UserToVisit", fields: [doctorId], references: [id])
  doctorId      String
  visitTime     DateTime       @default(now())
  reason        String?
  vitalsJson    Json?
  nextVisit     DateTime?
  notes         String?
  diagnoses     Diagnosis[]
  prescriptions Prescription[]
  tests         Test[]
}

// ---------- DIAGNOSIS ----------
model Diagnosis {
  id      String  @id @default(cuid())
  visit   Visit   @relation(fields: [visitId], references: [id])
  visitId String
  text    String
  icd10   String?
}

// ---------- PRESCRIPTION ----------
model Prescription {
  id      String             @id @default(cuid())
  visit   Visit              @relation(fields: [visitId], references: [id])
  visitId String
  type    PrescriptionType
  note    String?
  items   PrescriptionItem[]
}

// ---------- PRESCRIPTION ITEM ----------
model PrescriptionItem {
  id             String        @id @default(cuid())
  fileUrl        String?
  Prescription   Prescription? @relation(fields: [prescriptionId], references: [id])
  prescriptionId String?
}

// ---------- TEST ----------
model Test {
  id      String  @id @default(cuid())
  name    String
  result  String?
  visit   Visit   @relation(fields: [visitId], references: [id])
  visitId String
}

// ---------- ALLERGY ----------
model Allergy {
  id          String  @id @default(cuid())
  name        String
  description String?
  patient     Patient @relation(fields: [patientId], references: [id])
  patientId   String
}

// ---------- ENUMS ----------
enum Role {
  ADMIN
  DOCTOR
  ASSISTANT
}

enum PrescriptionType {
  CLINICAL
  OUTSIDE
  REGULAR
}

// ---------- GENERATOR & DATASOURCE ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
